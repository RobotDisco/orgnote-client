:PROPERTIES:
:ID: orgnote-agents
:END:

#+TITLE: OrgNote AI Agent Guidelines
#+DESCRIPTION: Project-specific guidelines for OrgNote development extending base_agents.org
#+FILETAGS: :ai:prompts:agents:orgnote:
#+STARTUP: content
#+OPTIONS: toc:nil
#+OPTIONS: tags:nil



* Project Overview
OrgNote is a cross-platform note-taking application providing full Emacs Org mode and Org-roam compatibility. Built for students, knowledge workers, and researchers who need powerful note organization across web, mobile, and desktop platforms.

** Tech Stack
- *Frontend*: Vue 3 + Quasar Framework (mobile-first)
- *State*: Pinia with persistence
- *Language*: TypeScript strict mode
- *Platforms*: PWA, Android/iOS (Capacitor), Electron, SSR
- *Architecture*: Plugin-based via =orgnote-api= interface
- *Package Manager*: Bun (primary), npm (fallback)
- *Testing*: Vitest
- *Code Quality*: ESLint (flat config), Prettier, Husky pre-commit hooks

#+INCLUDE: "/Users/darkawower/Yandex.Disk.localized/Dropbox/org-roam/programming/ai/base_agents.org"

* Project-Specific Rules

** TypeScript Strictness (ENFORCE beyond base rules)
- *Strict mode MANDATORY* - all code must pass strict type checking
- *NEVER use any type* - use =unknown= and narrow with type guards
- *ESLint rules IMMUTABLE* - disabling rules prohibited without explicit approval
- *Type inference* - let TypeScript infer when obvious, annotate when ambiguous

** Null vs Undefined Convention
*PREFER =undefined= over =null= throughout application:*

#+BEGIN_SRC typescript
// ✅ GOOD - use undefined
function getPane(id?: string): Pane | undefined {
  if (!id) return; // implicit undefined
  return panes.value[id];
}

// ❌ BAD - avoid null
function getPane(id: string | null): Pane | null {
  if (!id) return null;
  return panes.value[id];
}
#+END_SRC

*Use type guards for nullable checks:*
#+BEGIN_SRC typescript
import { isPresent, isNullable, isPresentAndNotNaN } from 'src/utils/nullable-guards';

// ✅ GOOD - type guard with automatic narrowing
if (isPresent(paneId)) {
  const pane = panes.value[paneId]; // TypeScript knows paneId is string
}

// ❌ BAD - manual check, no type narrowing
if (!activePaneId.value) return;
const pane = panes.value[activePaneId.value]; // Error: undefined in index
#+END_SRC

** Testing with Vitest
- *USE =test= keyword ONLY* - never use =describe= or =it=
- *NO test nesting* - flat test structure
- *Test public behavior* - ignore implementation details
- *Break the code* - write tests that expose bugs, not just pass
- *Never adapt tests to broken code* - fix the code, not the test
- *Cover all scenarios* - positive, negative, edge cases, errors

#+BEGIN_SRC typescript
// ✅ GOOD - flat structure, descriptive names
test('getFileContent returns content when file exists', async () => {
  const content = await fileManager.getFileContent('test.org');
  expect(content).toBe('# Test file');
});

test('getFileContent returns empty string when file not found', async () => {
  const content = await fileManager.getFileContent('missing.org');
  expect(content).toBe('');
});

test('getFileContent throws when no filesystem available', async () => {
  fileSystemManager.currentFs = undefined;
  await expect(fileManager.getFileContent('test.org')).rejects.toThrow();
});

// ❌ BAD - nested, vague names
describe('FileManager', () => {
  describe('getFileContent', () => {
    it('works', async () => { /* ... */ });
  });
});
#+END_SRC

- All test names should start with the testing entity name

* Architecture Requirements

** Plugin-Based Architecture (CRITICAL)
- *ALL public functionality* MUST be exposed via =orgnote-api= interfaces
- *Check API contract* in =src/boot/api.ts= before implementing features
- *Evaluate plugin needs* - ask "Would a plugin need this?" before making private
- *API package location* - =node_modules/orgnote-api= (via Yalc)

#+BEGIN_SRC typescript
// ✅ GOOD - exposed through API
const api: OrgNoteApi = {
  core: {
    useFileManager: useFileManagerStore,
    useSettings: useSettingsStore,
    useFileSystemManager: useFileSystemManagerStore,
  },
  ui: {
    useModal: useModalStore,
    useNotifications: useNotificationsStore,
  },
  utils: {
    copyToClipboard,
    uploadFile,
  },
};

// Access stores through API
import { api } from 'src/boot/api';
const fileManager = api.core.useFileManager();
#+END_SRC

** Mobile-First Development (MANDATORY)
- *Design for mobile FIRST* - then progressively enhance for desktop
- *Account for safe areas* - iOS notch, Android navigation, etc.
- *Touch-first interactions* - larger tap targets, swipe gestures
- *Test on real devices* - multiple sizes and orientations
- *Responsive by default* - use Quasar breakpoints (=lt.md=, =gt.sm=, etc.)

#+BEGIN_SRC vue
<template>
  <!-- ✅ GOOD - responsive with Quasar utilities -->
  <q-btn 
    :dense="$q.screen.lt.md" 
    :size="$q.screen.lt.md ? 'sm' : 'md'"
    @click="handleAction"
  >
    Action
  </q-btn>
</template>

<script setup lang="ts">
import { useQuasar } from 'quasar';
const $q = useQuasar();

const handleAction = () => {
  if ($q.platform.is.mobile) {
    // Mobile-specific UX
  }
  // Default behavior
};
</script>
#+END_SRC

** Multi-Platform Support
- *Support all platforms* - PWA, Android, iOS, Electron, SSR
- *USE platform utilities* from =src/utils/platform-specific.ts=:
  - =mobileOnly()=, =clientOnly()=, =androidOnly()=, =desktopOnly()=, =serverOnly()=
- *Consult docs* - Capacitor for native features, Quasar for platform detection
- *Test platform builds* - verify behavior on each target platform

** File System Abstraction (CRITICAL)
*NEVER assume specific filesystem implementation* - users can implement custom filesystem plugins.

*ALWAYS use FileSystemManager:*
#+BEGIN_SRC typescript
import { api } from 'src/boot/api';

const fileSystemManager = api.core.useFileSystemManager();
const fileSystem = fileSystemManager.currentFs;

// ✅ GOOD - check filesystem availability
if (!fileSystem) {
  api.ui.useNotifications().error('No filesystem connected');
  return;
}

const content = await fileSystem.readFile(path);

// ❌ BAD - assuming specific filesystem
const localFs = new LocalFileSystem(); // Don't do this
#+END_SRC

*Abstract ALL file operations* through =src/stores/file-system-manager.ts=.

* State Management with Pinia

** Store Access Pattern
*ALWAYS access stores via =api= object:*

#+BEGIN_SRC typescript
import { api } from 'src/boot/api';

// ✅ GOOD - through API
const fileManager = api.core.useFileManager();
const settings = api.core.useSettings();
const modal = api.ui.useModal();

// ❌ BAD - direct import (breaks plugin compatibility)
import { useFileManagerStore } from 'src/stores/file-manager';
const fileManager = useFileManagerStore(); // Don't do this
#+END_SRC

** State Persistence
- Pinia stores persist automatically where configured
- Check =src/stores/= for persistence setup
- Sensitive data (encryption keys) use platform-specific secure storage

* UI/UX Development

** Component Organization
- *Base components* - =src/components/= (reusable UI primitives)
- *Containers* - =src/containers/= (business logic wrappers)
- *Pages* - =src/pages/= (route-level components)
- *Layouts* - =src/layouts/= (page layout structures)

** Styling System (MANDATORY CSS Variables)

*CRITICAL: NEVER hardcode values - use design tokens from =src/css/variables.scss=*

*Design Token Categories:*
- *Spacing*: =--padding-{xs,sm,md,lg,xl}=, =--margin-*=, =--gap-*=
- *Typography*: =--font-size-*=, =--font-weight-*=, =--line-height-*=
- *Colors*: =--bg=, =--fg=, =--accent=, =--red=, =--green=, etc. (semantic)
- *Borders*: =--border-radius-{sm,md,lg}=, =--border-default=
- *Shadows*: =--shadow-{sm,md,lg}=
- *Components*: =--btn-*=, =--modal-*=, =--tab-*= (component-specific tokens)

#+BEGIN_SRC css
/* ✅ GOOD - design tokens */
.editor-toolbar {
  padding: var(--padding-md);
  gap: var(--gap-sm);
  background: var(--bg-alt);
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-sm);
}

/* ❌ BAD - hardcoded values */
.editor-toolbar {
  padding: 16px;
  gap: 8px;
  background: #f5f5f5;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
#+END_SRC

*Documentation:* See =VARIABLES.org= for complete token reference.

** Styling Approach
- *Main styles* - =src/css/app.scss=
- *Variables* - =src/css/variables.scss= (implementation of design tokens)
- *Quasar components* - leverage built-in components when possible
- *Theme support* - dark/light mode via CSS custom properties
- *Responsive* - mobile-first breakpoints
- *Mixins* Always use mixins when possible =src/css/mixins.scss=

* Internationalization (i18n)

** Setup
- *Framework*: Vue i18n configured in =src/i18n/=
- *Translation keys*: Defined in =orgnote-api/constants/i18n-keys.ts=
- *Languages*: Currently =en-US= (extensible)
- *Loading*: Lazy-loaded on demand

** Usage
#+BEGIN_SRC typescript
import { useI18n } from 'vue-i18n';
const { t } = useI18n();

// ✅ Use predefined keys
const label = t('commands.file.create');
const message = t('notifications.file.saved', { filename: 'note.org' });
#+END_SRC

* Security & Privacy (OrgNote-specific)

** Encryption & Data Protection
- *File encryption* - implemented in =src/stores/encryption.ts=
- *Secure storage* - platform-appropriate secure storage for keys
- *User data privacy* - all notes stored locally, user controls sync
- *No telemetry* - respect user privacy, no tracking without consent

** Safe File Operations
#+BEGIN_SRC typescript
// ✅ GOOD - comprehensive error handling
const readFileContent = async (filePath: string): Promise<string> => {
  const fileSystemManager = api.core.useFileSystemManager();
  const fileSystem = fileSystemManager.currentFs;
  
  if (!fileSystem) {
    throw new Error('No file system available');
  }
  
  try {
    return await fileSystem.readFile(filePath);
  } catch (error) {
    api.ui.useNotifications().error('Failed to read file');
    throw error; // Re-throw for caller to handle
  }
};
#+END_SRC

** Privacy in Development
- *NEVER commit* user notes, personal data, or test files with real content
- *USE fake data* in examples and tests
- *MASK sensitive info* when logging (file paths, user IDs)
- *Document privacy* implications of new features

* Extension & Widget Development

** Plugin API Design
When adding features, consider plugin ecosystem:

1. Would a plugin need access to this functionality?
2. Should this be exposed in =orgnote-api=?
3. Is the interface stable enough for public API?
4. Does it follow existing API patterns?

** Widget System
Support for Org mode inline elements:
- *Inline widgets* - =WidgetType.Inline= (inline elements like links, emphasis)
- *Multiline widgets* - =WidgetType.Multiline= (blocks, code blocks)
- *Line class widgets* - =WidgetType.LineClass= (headings, list items)

* Development Workflow

** Session Start Checklist
1. Check for updates to =base_agents.org= (base rules)
2. Review recent commits for context
3. Check open issues/PRs for related work
4. Verify all platforms still build (if touching core)

** Common Tasks
- *Add translation*: Update =orgnote-api/constants/i18n-keys.ts= + language files
- *Add store*: Create in =src/stores/=, expose via =src/boot/api.ts=
- *Add component*: =src/components/= (base) or =src/containers/= (business logic)
- *Add route*: Update =src/router/routes.ts=, create page in =src/pages/=
- *Add platform feature*: Use Capacitor plugins, check =src/utils/platform-specific.ts=

* Quick Reference

** Import Patterns
#+BEGIN_SRC typescript
// API access
import { api } from 'src/boot/api';

// Type guards
import { isPresent, isNullable } from 'src/utils/nullable-guards';

// Platform utilities
import { mobileOnly, desktopOnly } from 'src/utils/platform-specific';

// Quasar
import { useQuasar } from 'quasar';
import { QBtn, QInput } from 'quasar'; // Named imports for tree-shaking

// Vue i18n
import { useI18n } from 'vue-i18n';
#+END_SRC

** CSS Variable Quick Reference
#+BEGIN_SRC css
/* Spacing */
padding: var(--padding-md);
gap: var(--gap-sm);
margin: var(--margin-lg);

/* Typography */
font-size: var(--font-size-base);
font-weight: var(--font-weight-medium);
line-height: var(--line-height-normal);

/* Colors */
background: var(--bg);
color: var(--fg);
border: 1px solid var(--border-default);

/* Components */
border-radius: var(--border-radius-md);
box-shadow: var(--shadow-sm);
#+END_SRC

* Troubleshooting

** Common Issues
- *Type errors after update*: Run =bun install= to sync =orgnote-api=
- *Platform build fails*: Check Capacitor/Electron docs for breaking changes
- *Tests fail*: Ensure Vitest config matches project structure
- *CSS not updating*: Check if design tokens defined in =variables.scss=

** Getting Help
- Check =VARIABLES.org= for design system documentation
- Review =src/boot/api.ts= for available API surface
- Consult Quasar docs for component props and utilities
- Check Capacitor docs for native platform features
