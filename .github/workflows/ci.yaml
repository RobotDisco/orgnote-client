name: CI orgnote client

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment name (dev or deploy)'
      image_tag:
        required: true
        type: string
        description: 'Docker image tag (dev or latest)'
      trigger_event:
        required: false
        type: string
        default: ''
        description: 'Event type to trigger backend deployment'

jobs:
  install_dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - uses: actions/cache@v4
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/bun.lock') }}
      - name: Install dependencies
        run: bun install --frozen-lockfile

  lint:
    name: Run linters
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - uses: actions/cache@v4
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/bun.lock') }}
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Prepare Quasar
        run: bunx quasar prepare
      - name: Run linters
        run: bun run lint

  tests:
    name: Run tests
    runs-on: ubuntu-latest
    needs: [install_dependencies]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - uses: actions/cache@v4
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/bun.lock') }}
      - name: Create dummy certs for Quasar config
        run: |
          mkdir -p .certs
          openssl req -x509 -newkey rsa:2048 -keyout .certs/key.pem -out .certs/cert.pem -days 1 -nodes -subj "/CN=localhost"
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Prepare Quasar
        run: bunx quasar prepare
      - name: Run tests
        run: bun run test:ci

  push_image:
    name: Push Docker image
    runs-on: ubuntu-latest
    needs: [tests, lint]
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - name: Install dependencies
        run: |
          bun install --frozen-lockfile
          bun add global @quasar/cli
      - name: Init environment
        run: |
          cat <<EOT > .env.prod
          DEBUG=${{ inputs.environment == 'dev' && 'true' || 'false' }}
          VITE_API_URL=${{ secrets.API_URL }}
          VITE_AUTH_URL=${{ secrets.AUTH_URL }}
          EOT
          echo "=== .env.prod contents ==="
          cat .env.prod
          echo "=== end ==="
      - name: Build ssr
        run: |
          echo "=== Testing env-cmd ==="
          bunx env-cmd -f ./.env.prod env | grep -i VITE || echo "VITE vars not found"
          echo "=== Building ==="
          bun run build:ssr
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Override capacitor dependency
        uses: sergeysova/jq-action@v2
        with:
          cmd: 'jq ''. + {overrides: {"capacitor-folder-picker": {"@capacitor/core": "6.1.0"}}}'' ./dist/ssr/package.json > ./dist/ssr/tmp.json && mv -f ./dist/ssr/tmp.json ./dist/ssr/package.json'
          multiline: true
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/Dockerfile.ssr
          push: true
          tags: orgnote/client:${{ inputs.image_tag }}

  trigger_backend:
    runs-on: ubuntu-latest
    needs: [push_image]
    if: ${{ inputs.trigger_event != '' }}
    environment: ${{ inputs.environment }}
    steps:
      - name: Trigger backend deployment
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.PAT }}" \
            https://api.github.com/repos/artawower/orgnote-backend/dispatches \
            -d '{"event_type":"${{ inputs.trigger_event }}"}')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" != "204" ]; then
            echo "Error: Expected 204, got $http_code"
            exit 1
          fi
